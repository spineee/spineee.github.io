<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Subnet Scanner (with Latency)</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #1e1e1e; color: #d4d4d4; padding: 20px; }
        #console { background: #000; border: 1px solid #444; padding: 15px; height: 500px; overflow-y: scroll; font-family: monospace; font-size: 12px; }
        .found { color: #4ec9b0; font-weight: bold; }
        .timeout { color: #888; }
        .summary { margin-bottom: 10px; font-size: 1.1em; color: #ce9178; }
        .ms { color: #b5cea8; font-style: italic; margin-left: 10px; }
    </style>
</head>
<body>
    <h2>Subnet Scanner: 10.33.*.1</h2>
    <div class="summary" id="status">Initializing Scan...</div>
    <div id="console"></div>

    <script>
        const CONFIG = {
            baseIp: "10.33",
            port: 22,
            timeout: 500,
            concurrency: 50 
        };

        const consoleBox = document.getElementById('console');
        const statusBox = document.getElementById('status');
        let foundCount = 0;
        let scannedCount = 0;

        function log(message, className = "", ms = null) {
            const entry = document.createElement('div');
            entry.className = className;
            const timeStr = `[${new Date().toLocaleTimeString()}] `;
            const msStr = ms !== null ? ` <span class="ms">(${ms}ms)</span>` : "";
            
            entry.innerHTML = `${timeStr}${message}${msStr}`;
            consoleBox.appendChild(entry);
            consoleBox.scrollTop = consoleBox.scrollHeight;
        }

        async function checkHost(ip) {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), CONFIG.timeout);
            
            const startTime = performance.now(); // 开始计时
            
            try {
                await fetch(`https://${ip}:${CONFIG.port}`, { mode: 'no-cors', signal: controller.signal });
                
                const duration = Math.round(performance.now() - startTime);
                foundCount++;
                log(`[+] FOUND: ${ip}:${CONFIG.port}`, "found", duration);
            } catch (err) {
                const duration = Math.round(performance.now() - startTime);
                
                if (err.name === 'AbortError') {
                    log(`[-] TIMEOUT: ${ip}:${CONFIG.port}`, "timeout", duration);
                } else {
                    foundCount++;
                    log(`[+] FOUND (Refused): ${ip}:${CONFIG.port}`, "found", duration);
                }
            } finally {
                clearTimeout(id);
                scannedCount++;
                updateStatus();
            }
        }

        function updateStatus() {
            statusBox.textContent = `Progress: ${scannedCount} / 256 | Hosts Found: ${foundCount}`;
        }

        async function startBClassScan() {
            log(`Starting scan on ${CONFIG.baseIp}.*.1...`);
            
            let queue = [];
            for (let i = 0; i <= 255; i++) {
                queue.push(`${CONFIG.baseIp}.${i}.1`);
            }

            const workers = Array(CONFIG.concurrency).fill(null).map(async () => {
                while (queue.length > 0) {
                    const ip = queue.shift();
                    if (ip) await checkHost(ip);
                }
            });

            await Promise.all(workers);
            log("Scan completed.");
        }

        window.onload = startBClassScan;
    </script>
</body>
</html>
